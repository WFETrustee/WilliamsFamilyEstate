name: Auto-generate Manifests and Metadata Stubs

permissions:
  contents: write

on:
  push:
    branches:
      - master
    paths:
      - '**/*.html'
      - 'site-config.json'
      - '.github/scripts/**'
      - '.github/workflows/update-manifest.yml'
  workflow_dispatch:

jobs:
  update-site-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cheerio for DOM parsing
        run: npm install cheerio --no-save

      - name: Generate CSS Metadata Stubs (if enabled)
        run: node .github/scripts/generate-css-stubs.js

      - name: Distribute inherited root styles (if enabled)
        run: node .github/scripts/distribute-shared-styles.js

      - name: Generate Manifest Files and QR Routes
        run: node .github/scripts/generate-manifests.js

      - name: Inject style.css references into content HTML
        run: node .github/scripts/inject-styles-into-html.js

      - name: Clean duplicate style includes
        run: node .github/scripts/clean-style-links.js

      - name: Configure Git identity
        run: |
          git config user.name "WFE Bot"
          git config user.email "trustee@williamsfamilyestate.org"

      - name: Commit and push updated manifests and styles
        run: |
          git add **/*.json **/*.html **/style.css
          git commit -m "Auto-update metadata CSS stubs, manifests, and injected style links" || echo "No changes to commit"
          git pull
          git push origin HEAD:master

  trigger-deploy:
    needs: update-site-data
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy-public workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WFE_AUTOPUSH_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy-public
